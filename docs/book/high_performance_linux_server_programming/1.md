## TCP/IP协议族体系结构以及主要协议

TPC/IP 协议族是一个四层协议系统，自下而上分别是数据链路层、网络层、传输层、和应用层，上层协议使用下层协议提供的服务。

* **数据链路层**  
数据链路层实现了网卡接口的网络驱动程序，以处理数据在物理媒介（比如以太网、令牌环等）上的传输。  
常用协议 **ARP协议**（Address Resolve Protocol，地址解析协议）和 **RARP协议**（Reverse Address Resolve Protocol，逆地址解析协议），实现IP地址和机器物理地址（通常是MAC地址）之间的相互转换。

* **网络层**  
网络层实现数据包的选路和转发。  
核心协议是 **IP协议**，根据数据包的目的IP地址使用逐跳（hop by hop）的方式确定通信路径。  
另一个重要协议是 **ICMP协议**（Internet Control Message Protocol，因特网控制报文协议），主要用于检测网络连接。  
ICMP协议并非严格意义上的网络层协议，因为它使用处于同一层的IP协议提供的服务。

* **传输层**  
传输层为两台主机上的应用程序提供端到端（end to end）的通信。  
数据链路层（驱动程序）封装了物理网络的电气细节；网络层封装了网络连接的细节；传输层则为应用程序封装了一条端到端的逻辑通信链路，它负责数据的收发、链路的超时重连等。  
<br>
传输层主要协议：  
    * **TCP协议**（Transmission Control Protocol，传输控制协议）  
    TCP协议为应用层提供可靠的、面向连接的和基于流的服务。  
    基于流的数据没有边界（长度）限制，发送端可以逐个字节地写入数据，接收端也可以逐个字节地读出数据。

    * **UDP协议**（User Datagram Protocol，用户数据报协议）  
    UDP协议为应用层提供不可靠、无连接和基于数据报的服务。  
    每个UDP数据报都有一个长度，接收端必须以该长度为最小单位将内容一次性读出，否则数据将被截断。

    * **SCTP协议**（Stream Control Transmission Protocol，流控制传输协议）  
    SCTP协议是为了在因特网上传输电话信号而设计的。

* **应用层**  
应用层负责处理应用程序的逻辑。  
应用层协议（或程序）可能跳过传输层直接使用网络层提供的服务，比如ping程序和OSPF协议。  
应用层协议（或程序）通常既可以使用TCP服务，又可以使用UDP服务，比如DNS协议。  
可以通过 `/etc/services` 文件查看所有知名应用层协议。  
<br>
应用层主要协议/程序：
    * **ping程序**  
    ping是应用程序，而不是协议，利用ICMP报文检测网络连接，查看目标是否可到达。

    * **telnet协议**  
    一种远程登录协议。

    * **OSPF协议**（Open Shortest Path First，开放最短路径优先）  
    一种动态路由更新协议，用于路由器之间的通信，以告知对方各自的路由信息。

    * **DNS协议**（Domain Name Service，域名服务）  
    提供机器域名到IP地址的转换。

## 封装（encapsulation）
应用程序数据在发送到物理网络上之前，将沿着协议栈从上往下依次传递。每层协议都将在上层数据的基础上加上自己的头部信息（有时还包括尾部信息），以实现该层的功能，这个过程称为封装。

* 经过TCP封装后的数据称为TCP报文段（TCP message segment）或TCP段。由TCP头部信息和TCP内核缓冲区（发送缓冲区或接收缓冲区）数据构成。
* 经过UDP封装后的数据称为UDP数据报（UDP datagram）。UDP无需为应用层数据保存副本，当一个UDP数据报被成功发送之后，UDP内核缓冲区中的该数据报就被丢弃了。
* 经过IP封装后的数据称为IP数据报（IP datagram）。IP数据报也包括头部信息和数据部分（一个TCP报文段、UDP数据报或ICMP报文）。
* 经过数据链路层封装的数据帧称为帧（frame）。传输媒介不同，帧的类型也不同。    
以太网上传输的是以太网帧（ethernet frame）；令牌环网络上传输的是令牌环帧（token ring frame）。  
帧的最大传输单元（Max Transmit Unit，MTU），即帧最多能携带多少上层协议数据（比如IP数据报），通常受到网络类型的限制。**以太网帧的MTU是1500字节**。过长的IP数据报可能需要被分片（fragment）传输。  
帧才是最终在物理网络上传送的字节序列。

<protocol_header-ethernet_frame />

## 分用（demultiplexing）
当帧到达目的主机时，将沿着协议栈自下而上依次传递，各层协议依次处理帧中本层负责的头部数据，以获取所需的信息，最终将处理后的帧交给目标应用程序，这个过程称为分用。

* IP协议、ARP协议和RARP协议都使用帧传输数据，所以帧头部需要提供某个字段作为区分。  
如以太网帧使用2字节类型字段标识上层协议
    * 0x800 - IPv4数据报
    * 0x86dd - IPv6数据报
    * 0x806 - ARP请求或应答报文
    * 0x835 - RARP请求或应答报文
* ICMP协议、TCP协议和UDP协议都使用IP协议，IP数据报的头部采用16位协议字段来区分它们。
* TCP报文段和UDP数据报则通过其头部中的**16位端口号**（So 1 - 65535）字段来区分上层应用程序，比如DNS协议对应端口号53，HTTP协议对应80。

## ICMP协议
<protocol_header-icmp />

* 8位类型用于区分报文类型。分为两大类：
    * 差错报文，用于回应网络错误，比如目标不可达（类型值为3）和重定向（类型值为5）
    * 查询报文，用于查询网络信息，比如ping程序查看目标是否可到达（类型值为8）
* 8位代码，有的ICMP报文使用该字段进一步细分不同的条件。比如重定向报文使用0表示对网络重定向，1表示对主机重定向
* 16为校验和，使用该字段对整个报文（包括头部和内容部分）进行循环冗余校验（Cyclic Redundancy Cheek，CRC），以检验报文在传输过程中是否损坏
* 不同的ICMP报文类型具有不同的正文内容

## ARP协议
ARP协议能实现任意网络层地址到任意物理地址的转换，这里仅讨论IP地址到以太网地址（MAC地址）的转换。
* **工作原理**  
主机向自己所在的网络广播一个ARP请求，该请求包含目标机器的网络地址。此网络上的其他机器都将收到这个请求，但只有被请求的目标机器会回应一个ARP应答，其中包含自己的物理地址。  

* **以太网ARP请求/应答报文**  
ARP请求/应答报文的长度为28字节，加上以太网帧头部和尾部的18字节，则一个携带ARP请求/应答报文的以太网帧长度为46字节。  
有的实现要求以太网帧数据部分长度至少为46字节，此时ARP请求/应答报文将增加一些填充字节，以满足要求，此时总长度为64字节。
    * 硬件类型（2字节）：定义物理地址的类型，为1表示MAC地址
    * 协议类型（2字节）：表示要映射的协议地址类型，0x800表示IP地址（即表示应答报文应返回物理地址对应的IP地址）
    * 硬件地址长度（1字节）：对MAC地址来说长度为6
    * 协议地址长度（1字节）：对IPv4地址来说长度为4
    * 操作（2字节）：指4种操作类型：ARP请求(1)、ARP应答(2)、RARP请求(3)、RARP应答(4)
    * 发送端物理地址（6字节）
    * 发送端IP地址（4字节）
    * 目的端物理地址（6字节）
    * 目的端IP地址（4字节）

<protocol_header-arp />

* **ARP高速缓存**  
通常，ARP维护一个高速缓存，其中包含经常访问（比如网关地址）或最近访问的机器的IP地址到物理地址的映射。这样就避免了重复ARP请求，提高了发送数据包的速度。

## DNS协议
域名查询服务有很多种实现方式，比如NIS（Network Information Service，网络信息服务）、DNS和本地静态文件等。  
DNS是一套分布式的域名服务系统。每个DNS服务器上都存放着大量的机器名和IP地址的映射，并且是动态更新的。众多网络客户端程序都使用DNS协议来向DNS服务器查询目标主机的IP地址。  

`/etc/resolv.conf` 文件存放DNS服务器的IP地址  
常用的访问DNS服务器的客户端程序是 `host`，如 `host -t A www.baidu.com`，其中 `-t` 表示设置查询类型，A类型表示获取主机IP地址。

<protocol_header-dns />

### 1. 16位标识
用于标记一对DNS查询和应答，一对查询和应答报文的该字段值相同。

### 2. 16位标志
用于协商具体的通信方式和反馈通信状态。

<protocol_header-dns_flag />
* QR，查询/应答标志。0查询报文，1应答报文
* opcode，定义查询和应答的类型。0标准查询，1反向查询，2请求服务器状态
* AA，授权应答标志，仅由应答报文使用。1表示域名服务器是授权服务器
* TC，截断标志，仅当DNS报文使用UDP服务时使用。UDP数据报有长度限制，1表示DNS报文超过512字节并被截断
* RD，递归查询标志。1表示递归查询，0表示迭代查询（若目标DNS服务器无法解析则返回其他DNS服务器IP地址以供参考）
* RA，允许递归标志。仅由应答报文使用。1表示DNS服务器支持递归查询
* zero，未用，均置0
* rcode，返回码表示应答状态，0无错误，3域名不存在

### 3. 4个资源记录数
顺位的4个字段分别指出DNS报文最后4个字段的资源记录数
* 查询报文：一般包含1个查询问题，其他记录数为0
* 应答报文：应答资源记录数至少为1，授权资源记录数和额外资源记录数可为0或非0

### 4. 查询问题
<protocol_header-dns_query />
* 查询名，以一定的格式封装了要查询的主机域名
* 查询类型，表示如何执行查询操作
    * 类型A，值为1，表示获取目标主机的IP地址
    * 类型CNAME，值为5，表示获得目标主机的别名
    * 类型PIR，值为12，表示反向查询
* 查询类，通常为1，表示获取IP地址

### 5. 资源记录
应答字段、授权字段和额外信息字段都使用资源记录（Resource Record，RR）格式

<protocol_header-dns_rr />
* 32位域名，表示该记录中与资源对应的名字，格式与查询问题中的查询名字段相同
* 16位类型，同查询问题查询类型
* 16位类，同查询问题查询类
* 32位生存时间，表示查询记录结果可被本地客户端程序缓存的时间，单位为秒
* 16位资源数据长度，取决于类型字段，对于类型A为4（字节）
* 资源数据，取决于类型字段，对于类型A为32位IPv4地址

## socket与TCP/IP协议族的关系
数据链路层、网络层、传输层协议是在内核中实现的，所以操作系统需要实现一组系统调用使得应用程序能够访问这些协议提供的服务。  
实现这组系统调用的API主要有socket和XTI两套，XTI已基本不再使用。  
socket是一套通用网络编程接口，它不但可以访问内核中TCP/IP协议栈，还能访问其他网络协议栈（如X.25协议栈、UNIX本地域协议栈等）。  
socket提供的功能：  
* 将应用程序数据从用户缓冲区复制到TCP/UDP内核发送缓冲区，以交付内核发送数据，或从内核TCP/UDP接收缓冲区中复制数据到用户缓冲区，以读取数据。
* 应用程序可以通过它们来修改内核中各层协议的某些头部信息或其他数据结构，从而精细地控制底层通信的行为。
