## IP服务的特点
IP协议为上层提供无状态、无连接、不可靠的服务。
* **无状态**（stateless）  
指IP通信双方不同步传输数据的状态信息，所有IP数据报的发送、传输和接收都是相互独立、没有上下文关系的，因此可能出现乱序、重复的IP数据报。  
比如，发送端发出的第N个IP数据报比第N+1个IP数据报后到达接收端；同一个数据报可能经过不同的路径多次到达接收端。  
优点是：简单、高效。无须为保持通信状态而分配一些内核资源，也无须每次传输数据时都携带状态信息。

* **无连接**（connectionless）  
指IP通信双方都不长久地维持对方的任何信息，上层协议每次发送数据的时候，都必须明确指定对方的IP地址。

* **不可靠**  
指不能保证IP数据报准确地到达接收端，只承诺尽最大努力（best effort）。很多情况到能导致IP数据报发送失败。  
比如，某个中转路由器发现IP数据报在网络上存活的时间太长（根据TTL），那么它将丢弃之，并返回一个ICMP错误消息（超时错误）给发送端；  
接收端发现收到的IP数据报不正确（根据校验机制），也将丢弃之，并返回一个ICMP错误消息（IP头部参数错误）给发送端。  
发送端的IP模块一旦检测到IP数据报发送失败，就通知上层协议发送失败，而不会试图重传。

## IPv4头部结构
长度通常为20字节，除非含有可变长的选项部分（最多40字节）。

<protocol_header-ipv4 />

* 4位版本号（version）：指定IP协议的版本，对IPv4来说值为4。
* 4位头部长度（header length）：表示该IP头部有多少个32bit。4位最大为15，所以IP头部最长60字节。
* 8位服务类型（Type Of Service，TOS）：包括3位优先权字段（已被忽略）、4位TOS字段和1位保留字段（必须置0）。4位TOS字段分别表示：最小延时，最大吞吐量，最高可靠性和最小费用，最多有一个能置1。  
比如，ssh和telnet这样的登录程序需要的是最小延时服务；而文件传输程序ftp需要的是最大吞吐量服务。
* 16位总长度（total length）：整个IP数据报的长度，16位最大为65535。由于MTU的限制，超过MTU的数据报都将被分片传输。
* 16位标识（identification）：唯一地标识主机发送的每一个数据报。初始值由系统随机生成；每发送一个数据报，其值加1。一个数据报的所有分片具有相同标识值。
* 3位标志：第一位保留。  
第二位（Don't Fragment，DF）表示禁止分片，若置为1则IP模块将不对数据报进行分片，此时若IP数据报长度超过MTU，IP模块将丢弃数据报并返回一个ICMP差错报文。
第三位（More Fragment，MF）表示更多分片，除了数据报最后一个分片外，其他分片都要置为1。
* 13位分片位移（fragmentation offset）：表示分片相对原始IP数据报开始处的偏移（字节）。实际偏移值是该值乘以8的结果（位）。所以除了最后一个分片以外，每个IP分片的数据部分长度必须是8的整数倍。
* 8位生存时间（Time To Live，TTL）：表示数据报到达目的地之前允许经过的路由器跳数。TTL由发送端设置（常见值为64）。  
数据报在转发过程中每经过一个路由，该值就被路由器减1。当TTL值减为0时，路由器将丢弃数据报，并向源端发送一个ICMP差错报文。
* 8位协议（protocol）：用于区分上层协议。`/etc/protocols` 文件定义了所有上层协议对应的protocol字段数值。ICMP是1，TCP是6，UDP是17。
* 16位头部校验和（header checksum）：由发送端填充，接收端对其使用CRC算法以检验IP数据报头部在传输过程中是否损坏（仅检验头部）。
* 32位源端IP地址
* 32位目的端IP地址
* 选项（option）：可变长的可选信息。最多包含40字节（60-20）。可用的IP选项：
    * 记录路由（record route）：告诉数据报途径的所有路由器都将自己的IP地址填入IP头部选项部分，以跟踪数据报的传递路径。
    * 时间戳（timestamp）：告诉每个路由器都将数据报被转发的时间（或时间与IP地址对）填入IP头部选项部分，以测量途径路由之间数据报传输时间。
    * 松散源路由选择（loose source routing）：指定一个路由器IP地址列表，数据报发送过程中必须经过其中所有路由器。
    * 严格源路由选择（strict source routing）：类似于松散源路由选择，数据报只能经过被指定的路由器。

## IP路由
IP数据报应该发送至哪个下一跳路由（或者目标机器），以及经过哪个网卡来发送，就是IP路由过程。  
路由表是IP模块实现数据报路由的核心数据结构。

* **路由表**  
使用 `route` 命令查看路由表内容。
    * **Destination**：目标网络或主机，default即默认路由项
    * **Gateway**：网关地址，\*表示目标和本机在同一个网络，不需要路由
    * **Genmask**：网络掩码
    * **Flags**：路由项标志，常见以下5种：
        * U：该路由项是活动的
        * H：该路由项的目标是一台主机
        * G：该路由项的目标是网关
        * D：该路由项是由重定向生成的
        * M：该路由项被重定向修改过
    * **Metric**：路由距离，即到达指定网络所需的中转数
    * **Ref**：路由被引用的次数（Linux未使用）
    * **Use**：该路由项被使用的次数
    * **Iface**：该路由项对应的输出网卡接口

Destination | Gateway | Genmask           | Flags   | Metric  | Ref     | Use     | Iface
:-----:     | :-----: | :-----:           | :-----: | :-----: | :-----: | :-----: | :-----:
default     | gateway | 0.0.0.0           | UG      | 0       | 0       | 0       | eth0
192.168.1.0 | *       | 255.255.255.0     | U       | 1       | 0       | 0       | eth0

* **路由机制**
1. 查找路由表中和数据报目标IP地址完全匹配的主机IP地址，若找到就使用该路由项；未找到则跳转至2
2. 查找路由表中和数据报目标IP地址具有相同网路ID的网络IP地址，若找到就使用该路由项；未找到则跳转至3
3. 选择默认路由项，这通常代表数据报的下一跳路由是网关。（访问因特网的请求都通过网关转发）

* **路由表更新**
    * 通过route命令或其他工具手动修改路由表
    * 通过BGP（Border Gateway Protocol，边际网关协议）、RIP（Routing Information Protocol，路由信息协议）、OSPF等协议发现路径，动态、自动更新路由表。
    * ICMP重定向报文

## IP转发  
不是发送给本机的IP数据报将由数据报转发子模块来处理。  
路由器都能执行数据报的转发操作，主机一般只发送和接收数据报。  
主机上 `/proc/sys/net/ipv4/ip_forward` 文件内核参数默认设置为0，修改为1则开启主机的数据报转发功能。

对于允许IP数据报转发的系统（主机或路由器），数据报转发子模块将对期望转发的数据报执行如下操作
1. 检查数据报头部TTL值，若TTL已为0，丢弃该数据报。
2. 查看数据报头部的严格源路由选择选项。如果该选项被设置，则检测数据报的目标IP地址是否是本机的某个IP地址，若不是则发送一个ICMP源站选路失败报文给发送端。
3. 如果有必要则给源端发送一个ICMP重定向报文，以告诉它一个更合理的下一跳路由器。
4. TTL值减1。
5. 处理IP头部选项。
6. 如果有必要则执行IP分片操作。

## ICMP重定向
<protocol_header-icmp_redirect />

* ICMP重定向报文类型值为5。  
* 代码字段有4个可选值，用于区分不同的重定向类型，这里仅讨论主机重定向，代码值为1。  
* 数据部分提供了2个信息：
    * 引起重定向的IP数据报的源端IP地址
    * 应该使用的路由器的IP地址

接收主机根据它们可以断定引起重定向的IP数据报应该使用哪个路由器来转发，并更新路由表（通常是更新路由表缓冲，而不是直接更改路由表）。  
`/proc/sys/net/ipv4/conf/all/send_redirects` 文件指定了是否允许发送ICMP重定向报文；  
`/proc/sys/net/ipv4/conf/all/accept_redirects` 文件指定了是否允许接收ICMP重定向报文。  
一般来说，主机只能接收ICMP重定向报文，路由器只能发送ICMP重定向报文。

## IPv6
### 固定头部结构
<protocol_header-ipv6 />

* 4位版本号（version），指定IP协议版本，IPv6为6
* 8位通信类型（traffic class），指示数据流通信类型或优先级，类似IPv4的TOS
* 20位流标签（flow label），用于某些对连接的服务质量有特殊要求的通信，比如音频或视频等实时数据传输
* 16位净荷长度（payload length），表示IPv6扩展头部和应用程序数据长度之和，不包括固定头部长度
* 8位下一个报头（next header），表示紧跟IPv6固定头部后的报头类型，如扩展头或某个上层协议头。类似IPv4的协议字段，且相同取值具有相同含义
* 8位跳数限制（hop limit），同IPv4的TTL

IPv6使用**128位**（16字节）表示IP地址。  
**32位**表示的IPv4地址一般用点分十进制来表示，IPv6地址使用十六进制字符表示。  
IPv6使用 `:` 分成8组，每组2字节，可使用零压缩法简写（省略连续的、全0的组），但仅能使用一次  
如 `FE80:0000:0000:0000:1234:5678:0000:0012` 可简写为 `FE80::1234:5678:0000:0012`

### 扩展头部
可变长扩展头支持更多的选项。  
扩展头部长度可以为0，表示未使用任何扩展头；  
一个数据报可以包含多个扩展头部，每个扩展头部类型由前一个头部的 下一个报头字段 指定。  

一些可使用的扩展头部
扩展头部                        | 含义
:----:                         | :----:
Hop-by-Hop                     | 逐跳选项头部，包含每个路由器都必须检查和处理的特殊参数选项
Destination options            | 目的选项头部，指定由最终目的节点处理的选项
Routing                        | 路由头部，指定数据报需要经过的中转路由器，类似IPv4的记录路由选项和松散源路由选项
Fragment                       | 分片头部，处理分片和重组的细节
Authentication                 | 认证头部，提供数据源认证、数据完整性检查和反重播保护
Encapsulating Security Payload | 加密头部，提供加密服务
No next header                 | 没有后续扩展头部


















