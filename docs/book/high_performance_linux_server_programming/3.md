## TCP服务特点
TCP协议相对于UDP协议的特点是：**面向连接、字节流和可靠传输**。
* 使用TCP协议通信的双方必须先建立连接，并为该连接分配必要的内核资源。完成数据交换后，通信双方必须断开连接以释放系统资源。  
TCP连接是**全双工**的（Full Duplex），即可以同时进行信号的双向传输（这里指数据的读写）。  
TCP连接是一对一的，无连接的UDP适合广播和多播的应用程序。

* 字节流服务和数据报服务的区别对应到实际编程中，体现为通信双方是否必须执行相同次数的读、写操作。  
TCP发送端指定的写操作次数和接收端指定的读操作次数之间没有任何数量关系，即字节流，应用程序对数据的发送和接收是没有边界限制的。  
对于UDP，当发送端每执行一次写操作，UDP模块就将其封装成UDP数据报并发送，接收端必须及时针对每一个UDP数据报执行读操作，否则就会丢包。并且，当未指定足够的应用程序缓冲区来读取时，UDP数据将被截断。

* TCP采用发送应答机制，发送的报文必须得到应答才认为传输成功。  
TCP采用超时重传机制，发送端发出报文后启动定时器，若在定时时间内未收到应答将重发该报文。  
由于TCP报文最终以IP数据报发送，到达接收端可能乱序、重复，所以TCP会对接收到的TCP报文重排、整理，再交给应用层。

## TCP头部结构
<protocol_header-tcp />

* 16位端口号（port number）
* 32位序号（sequence number），一次TCP通信过程中某个传输方向上的字节流的字节编号。  
例如A → B的第一个TCP报文，序号值被初始化为某个随机值ISN（Initial Sequence Number），那么在该传输方向上，后续TCP报文的序号值之将被设置成 ISN+偏移（携带数据的第一个字节在整个字节流中的偏移）
* 32位确认号（acknowledgement number），用于对另一方送到的TCP报文的响应，值为收到的TCP报文序号值加1
* 4位头部长度（header length），标识该TCP头部有多少32bit，TCP头部最长40字节
* 6位标志：
    * URG，表示紧急指针是否有效
    * ACK，表示确认号是否有效，携带该标志的TCP报文称为确认报文
    * PSH，提示接收端应用程序应立即从TCP接收缓冲区读走数据，为接收后续数据腾出空间
    * RST，表示要求对方重新建立连接，携带该标志的TCP报文称为复位报文
    * SYN，表示请求建立一个连接，携带该标志的TCP报文称为同步报文
    * FIN，表示通知对方本端准备关闭连接，携带该标志的TCP报文称为结束报文
* 16位窗口大小（window size），指接收通告窗口（Receiver Window，RWND），告诉对方本端TCP接收缓冲区还能容纳的字节数据量，以控制发送数据的速度
* 16位校验和（TCP checksum），使用CRC算法检验报文是否损坏。该校验不仅包括TCP头部，也**包括数据部分**。
* 16位紧急指针（urgent pointer），一个正的偏移量。与序号字段的值相加表示最后一个紧急数据（1字节...）的下一个字节的序号，即相对当前序号的偏移
* 选项  
    * kind=0，表示结束选项
    * kind=1，空操作（nop）选项，没有特殊含义，一般用于将TCP选项总长度填充为4的整数倍
    * kind=2，length=4，info=MSS（2字节）  
    TCP连接初始化时（仅出现在同步报文中），通信双方使用该选项协商最大报文长度（Max Segemnt Size，MSS）。  
    TCP模块通常设置为（MTU - 40）字节，对以太网来说即1460字节，避免本机发生IP分片。  
    其中 40 = TCP头部（20）+ IP头部（20），假设它们都不含选项字段（一般情况下就是如此）。
    * kind=3，length=3，info=移位数（1字节）  
    TCP连接初始化时（仅出现在同步报文中），通信双方使用该选项协商接收通告窗口的扩大因子，取值范围为0 ~ 14。  
    实际接收通告窗口大小为头部中的窗口大小值左移该值位数（乘以2^该值）。  
    `/proc/sys/net/ipv4/tcp_window_scaling` 文件启停窗口扩大因子选项
    * kind=4，length=2  
    用在连接初始化时，表示是否支持选择性确认（Selective Acknowledgment，SACK）。  
    若某个TCP报文丢失，该选项使TCP模块只重新发送丢失的TCP报文，不用重发所有未被确认的TCP报文（指该丢失报文之后的部分）。  
    `/proc/sys/net/ipv4/tcp_sack` 文件启停选择性确认选项
    * kind=5，length=N \* 8 + 2，info=N块不连续数据块（8字节/块）  
    SACK实际工作的选项。发送端根据不连续数据块检查并重发丢失的数据块。  
    一个块分为2个部分（均为4字节）：  
    左边沿（edge of block），表示不连续块的第一个数据序号；  
    右边沿，表示不连续块的最后一个数据序号的下一个序号。  
    <br>
    其中左边沿与右边沿之间的数据是需要重发的部分。  
    因为一个块8字节，所以TCP头部选项中实际最多可包含4个这样的不连续数据块
    * kind=8，length=10，info=时间戳值（4字节）+ 时间戳回显应答（4字节）  
    该选项提供了较为准确的计算通信双方之间的回路时间（Round Trip Time，RTT）的方法。  
    `/proc/sys/net/ipv4/tcp_timestamps` 文件启停时间戳选项

kind（1字节）    | length（1字节）        | info（n字节）
:---:           | :---:                 | :---:
选项的类型   | 选项总长度（可能无）        | 选项的具体信息（可能无）

## TCP连接的建立与关闭
### 时序
* **TCP三次握手**
    1. 客户端发送携带SYN标志的同步报文
    2. 服务端发送携带SYN标志和ACK号的同步报文
    3. 客户端发送确认报文，连接建立
* **TCP四次挥手**
    1. 客户端发送携带FIN标志的结束报文（也可能是服务端先发起关闭）
    2. 服务端发送确认报文（可省）
    3. 服务端发送携带FIN标志的结束报文
    4. 客户端发送确认报文，连接关闭

### 半关闭状态
通信的一端可以发送结束报文给另一端，但允许继续接收来自另一端的数据，直到另一端也发送结束报文以关闭连接。TCP连接的这种状态称为半关闭（half close）状态。

### 连接超时
首次发出的同步报文没有应答时，TCP会尝试重连（可能执行多次），若重连仍然无效，则通知应用程序连接超时。  
文件 `/proc/sys/net/ipv4/tcp_syn_retries` 定义了系统最多发送多少个SYN报文才决定放弃。  
每次重连的超时时间都会增加一倍。（1s - 2s - 4s - 8s - 16s - 32s）

## TCP状态转移
此处仅描述客户端主动连接、主动关闭的情况
### 服务端
* 通过LISTEN系统调用进入LISTEN状态，被动等待客户连接
* 接收到同步报文后（新连接），将该连接放入内核等待队列中，并发送确认报文，处于SYN_RCVD状态
* 接收到确认报文后，转移至ESTABLISHED状态
* 当客户端主动关闭连接时，服务端发送确认报文进入CLOSE_WAIT状态
* 通常此时会立即发送一个结束报文关闭连接，转移至LAST_ACK状态
* 收到确认报文后，连接关闭及CLOSED状态

### 客户端
* 通过connect系统调用发送一个同步报文，转移至SYS_SENT状态。connect系统调用可能因为以下两个原因失败返回：
    * connect连接的目标端口不存在或者该端口被处于TIME_WAIT状态的连接所占用，服务端会发送一个复位报文，connect调用失败
    * 若未发生上述情况，但connect在超时时间内未收到确认报文，则connect调用失败
* connect调用失败则返回CLOSED状态；收到服务端的同步报文和确认，则转移至ESTABLISHED状态
* 当客户端主动关闭时，它向服务端发送一个结束报文，进入FIN_WAIT_1状态
* 转移至TIME_WAIT的2种可能：
    * 收到来自服务端的确认报文，转移至FIN_WAIT_2状态，此时可能发生半关闭状态。  
    收到来自服务端的结束报文，发送确认报文后进入TIME_WAIT状态
    * 收到来自服务端的带确认的结束报文，发送确认报文后直接进入TIME_WAIT状态
* TIME_WAIT结束后转移至CLOSED状态

### TIME_WAIT状态
客户端进入TIME_WAIT状态后，客户端连接要等待一段长为2MSL（Maximum Segment Life，报文段最大生存时间）的时间才能完全关闭，建议值是2min。  
作用有两点：
1. 可靠地终止TCP连接
2. 保证让尚未被接收到的、迟到的TCP报文有足够的时间被识别并丢弃

## 复位报文段
在某些情况下，TCP连接一端会向另一端发送携带RST标志的复位报文段，以通知对方关闭连接或重新建立连接。  
复位报文段的接收窗口大小为0，接收端不能回应这个报文。

* 客户端访问不存在的端口或客户端请求的端口被处于TIME_WAIT状态的连接占用时
* 连接的一端主动发送复位报文段异常终止连接，此时发送端所有等待发送的数据都将被丢弃
* 处于半打开状态的连接，半打开连接向另一端发送数据时会收到复位报文

## TCP交互数据流
TCP报文携带的应用程序数据按照长度分为：
* **交互数据**  
仅包含很少的字节，对实时性要求高，比如telnet、ssh
* **成块数据**  
通常为TCP报文端允许的最大数据长度，对传输效率要求高，比如ftp

## 带外数据 
有些传输层协议具有带外数据（Out Of Band，OOB）的概念，比普通数据（带内数据）有更高的优先级，应该总是被立即发送。  
实际应用中少见，已知有telnet、ftp等远程非活跃程序。  
UDP没有实现带外数据传输，TCP没有真正的带外数据（紧急指针，1字节...）

## TCP超时重传
TCP模块为每个TCP报文维护一个重传定时器，超时时间内未到应答，则重传报文并重置定时器。  
类似TCP超时重连，每次重传超时时间增加一倍。  
文件 `/proc/sys/net/ipv4/tcp_retries1` 指定了在底层IP接管之前TCP最少执行的重传次数，默认为3（失败太多，由底层接管...）  
文件 `/proc/sys/net/ipv4/tcp_retries2` 指定了连接放弃前TCP最多可以执行的重传次数，默认为15

## 拥塞控制
TCP模块的重要任务之一就是，提高网络利用率，降低丢包率，并保证网络资源对每条数据流的公平性，即拥塞控制。  
拥塞控制包括慢启动（slow start）、拥塞避免（congestion avoidance）、快速重传（fast retransmit）和快速回复（fast recovery）。  
拥塞控制算法有多种实现，文件 `/proc/sys/net/ipv4/tcp_congestion_control` 指定了当前使用的算法。  

* 名词解释
    1. 发送端向网络一次连续写入的数据量（收到其中第一个数据的确认之前），称为**SWND**（Send Window，发送窗口）；  
    2. SWND限定了发送端能连续发送的TCP报文段数量，这些报文段的最大长度（仅数据部分）称为**SMSS**（Sender Maximum Segment Size，发送者最大段大小），一般等于MSS；  
    3. 实际的SWND值为RWND（接受通告窗口）和**CWND**（Congestion Window，拥塞窗口）的较小者。  
    4. **ssthresh**（slow start threshold size，慢启动门限），当CWND超过该值时，拥塞控制进入拥塞避免阶段。

* **慢启动**  
TCP模块刚开始发送数据时不知道网络的实际情况，需要用一种试探性的方式平滑地增加CWND，初始值为2\~4个SMSS，之后按照指数形式扩大，即慢启动。  
出现慢启动的2种可能情况是刚开始发送数据和传输超时造成拥塞。

* **拥塞避免**  
拥塞避免算法使得CWND按照线性方式增加，减缓其扩大。  
拥塞避免并非完全能够避免拥塞，而是使网络比较不容易出现拥塞。

* **快速重传**、**快速恢复**  
发送端可能接收到重复的确认报文，比如TCP报文丢失；接收端收到乱序TCP报文等。  
发送端如果连续接收到3个重复的确认报文，则认为此时发生了拥塞。  
    1. 快速重传：立即重传丢失的报文，
    2. 快速恢复：收到新数据（丢失的后一个...?）确认时，设置CWND=ssthresh（新计算值），进入拥塞避免阶段。
